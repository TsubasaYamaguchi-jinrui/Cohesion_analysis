# オスの攻撃と怪我の関連  
本章では、オスから受けた攻撃の頻度と怪我の有無の関連について検討します。  

## データの加工  
まず怪我のデータを読み込みます。    
```{r}
## 怪我データの読み込み  
injury_m18 <- read_excel("../Data/data/2018mating/2018mating_raw.xlsx", sheet = "injury")
injury_m19 <- read_excel("../Data/data/2019mating/2019mating_raw.xlsx", sheet = "injury")
injury_m20 <- read_excel("../Data/data/2020mating/2020mating_raw.xlsx",sheet = "injury")
injury_m21 <- read_excel("../Data/data/2021mating/2021mating_raw.xlsx",sheet = "injury")
injury_nm19 <- read_excel("../Data/data/2019nonmating/2019nonmating_raw.xlsx", sheet = "injury")
injury_nm21 <- read_excel("../Data/data/2021nonmating/2021nonmating_raw.xlsx",sheet = "injury")
injury_nm22 <- read_excel("../Data/data/2022nonmating/2022nonmating_raw.xlsx",sheet = "injury")

injury_all <- bind_rows(injury_m18,injury_m19,injury_m20,injury_m21,
                        injury_nm19,injury_nm21,injury_nm22) %>% 
  pivot_longer(Kur:Har, names_to = "femaleID", values_to = "injury") %>% 
  mutate(injury01 = ifelse(injury >= 1, 1, 0)) %>% 
  mutate(date = as_date(date))
```

続いて、攻撃データを加工し、各個体の被攻撃頻度を日ごとに算出します。    
```{r}
### 個体ごとの被攻撃頻度  
agg_each <- aggression_all %>% 
  left_join(att, by = c("study_period", "femaleID")) %>% 
  filter(!is.na(age)) %>% 
  group_by(date, femaleID) %>% 
  summarise(no_agg = n()) %>% 
  ungroup() %>% 
  complete(date,femaleID) %>% 
  replace_na(list(no_agg = 0)) %>% 
  mutate(study_period = str_c("m",str_sub(year(date),3,4))) %>% 
  left_join(att, by = c("study_period", "femaleID")) %>% 
  ## 6歳以上を抽出  
  filter(!is.na(age)) 

### 個体データに結合  
## 各集団で確認できたメスと集団を追跡した時間を算出
group_all %>% 
  mutate(date = as_date(date),
         duration1 = as.numeric(difftime(fin, start, units = "mins")),
         duration2 = as.numeric(difftime(restart, suspend, units = "mins")))%>%
  mutate(duration1 = replace_na(duration1,0),
         duration2 = replace_na(duration2,0)) %>%
  mutate(duration = as.numeric(duration1 - duration2)) %>%  
  select(groupID, study_period, date, duration, Kur:Yun) %>% 
  select(-c(TY,IT, LK, KR, KM, TG)) %>% 
  pivot_longer(cols = Kur:Yun,
               names_to = "femaleID",
               values_to = "presence") %>% 
  left_join(att) %>% 
  filter(presence == 1 & age >= 6)  %>% 
  filter(date >= "2018-10-08") %>% 
  left_join(agg_each %>% select(date, femaleID, no_agg, study_period)) %>% 
  replace_na(list(no_agg = 0)) -> agg_rate_each
```

最後に、被攻撃頻度のデータと怪我データを結合します。また、フォーカルをその日にしたか否かの列も作成します。    
```{r}
## データを結合  
injury_final <- agg_rate_each %>% 
  left_join(injury_all, by = c("date", "femaleID")) %>% 
  left_join(female_all %>% select(date, femaleID, rs2),
            by = c("date", "femaleID")) %>%  
  drop_na(injury) %>% 
  left_join(focal_list %>% 
              group_by(date, subject) %>% 
              summarise(n_points = sum(n_points)) %>% 
              ungroup() %>% 
              select(date, subject, n_points) %>% 
              rename(femaleID = subject) %>% 
              mutate(focal = 1)) %>% 
  replace_na(list(n_points = 0,
                  focal = 0))
```

以下のようになりました。  
```{r}
datatable(injury_final)
```
<br/>  

## 分析  
### 交尾期と非交尾期の比較  
まず、交尾期と非交尾期の怪我頻度の違いを調べます。  

#### モデリング  
分析には、十分に観察を行った日(観察時間が240分以上)のみを用います。  

- 応答変数: 怪我が確認されたか否か(`injury01`)    
- 説明変数: 季節(`mating_an` vs `mating_es` vs `nonmating`)、観察時間(`duration`)  
- ランダム切片: メスID(`femaleID`)  

```{r}
injury_analysis_season <- injury_final %>% 
  filter(duration >= 240) %>% 
  mutate(season = if_else(str_detect(study_period, "nm"),
                          "nonmating", "mating")) %>% 
  mutate(season2 = case_when(
    season == "nonmating" ~ "nonmating",
    season == "mating" & rs2 == 1 ~ "mating_es",
    season == "mating" & rs2 == 0 ~ "mating_an",
    .default = NA
  ))

m_injury_season <- brm(injury01 ~ season2 + (1|femaleID),
                       family = bernoulli,
                       iter = 11000, warmup = 1000, seed = 13,
                       prior = c(prior(student_t(4,0,15), class = "b"),
                                 prior(student_t(4,0,15), class = "Intercept"),
                                 prior(student_t(4,0,10), class = "sd")),
                       control=list(adapt_delta = 0.9999, max_treedepth = 20),
                       backend = "cmdstanr",
                       data = injury_analysis_season,
                       file = "model/m_injury_season.rds")
```

#### モデルチェック  
まず、DHARMaパッケージ[@Hartig2022]とDHARMa.helperパッケージ[@Francisco2023]でモデルの前提が満たされているかを確認する。いずれのモデルも特に問題はないよう。 
```{r, fig.height = 4}
## 全期間    
dh_injury_season <- dh_check_brms(m_injury_season, quantreg = TRUE)
```
<br/>  

ゼロ過剰などの問題もない。  
```{r}
testZeroInflation(dh_injury_season)
```
<br/>  

bayesplotパッケージ[@Gabry2022]の`pp_check`関数で、事後分布からの予測分布と実測値の分布を比較しても大きな乖離はない。   
```{r, fig.height = 4.5}
## 全期間    
pp_check(m_injury_season, ndraws = 100)+
  theme_bw()+
  theme(aspect.ratio = 0.9)
```  
<br/>  

多重共線性のチェックも行ったが、VIFに問題はない。  
```{r}
## 全期間  
check_collinearity(m_injury_season)
```
<br/>  

Rhatにも問題はなく、収束の問題はないよう。  
```{r, fig.dim = c(8,4)}
data.frame(Rhat = brms::rhat(m_injury_season)) %>% 
  ggplot(aes(x = Rhat))+
  geom_histogram(fill = "white",
                 color = "black")+
  theme_bw()+
  theme(aspect.ratio = 1)
```
<br/>  

#### 結果の確認  
##### 推定された係数  
まずは、推定された係数を確認します。  
```{r, echo = FALSE}
summary_injury_season <- summary(m_injury_season)

model_parameters(m_injury_season, dispersion = TRUE, ci = 0.95,
                 centrality = "median", ci_method = "eti") %>% 
  data.frame() %>%
  dplyr::select(1,2,3,5,6, 7,8) %>% 
  mutate("Bulk ESS" = summary_injury_season $fixed$Bulk_ESS,
         "Tail ESS" = summary_injury_season $fixed$Tail_ESS) %>% 
  mutate("95%CI" = str_c("[",sprintf("%.2f",CI_low),", ",sprintf("%.2f",CI_high),"]")) %>% 
  dplyr::select(c(1,2,3, 10), everything()) %>% 
  dplyr::select(-CI_low, -CI_high) %>% 
  mutate(pd = str_c(sprintf("%.2f",pd*100))) %>% 
  rename(`PD (%)` = pd) %>% 
  mutate(Parameter = fct_relevel(Parameter,
                                 "b_Intercept",
                                 "b_season2mating_es", "b_season2nonmating")) %>% 
  arrange(Parameter) %>% 
  mutate(Parameter = str_replace_all(Parameter, c("b_Intercept"="Intercept",
                                                  "b_season2mating_es" = "MS(estrous) vs MS(anestrus)",
                                                  "b_season2nonmating" = "NMS vs MS(anestrus)",
                                                  "b_duration" = "Duration of group follow"))) %>% 
  rename("Explanatory variables" = "Parameter") %>% 
  mutate(across(where(is.numeric), ~sprintf("%.2f", .))) -> table_injury_season

table_injury_season

write_csv(table_injury_season, "tables/table_injury_season.csv")
```
<br/>  

##### 多重比較  
続いて、季節/発情の有無について多重比較を行います。いずれも有意な差があることが分かります。    
```{r}
emm_injury_season <- emmeans(m_injury_season,
                             ~ season2,
                             type = "response") 

pairs(emm_injury_season)
```

#### 結果の図示  
最後に、結果を図示します。     
```{r, fig.height = 4}
injury_analysis_season %>% 
  group_by(femaleID, season2) %>% 
  summarise(prop_injury = mean(injury01)) %>% 
  mutate(season2 = fct_relevel(season2,
                               "nonmating", "mating_an")) %>% 
  ggplot(aes(x = season2, y = prop_injury)) +
  geom_violin(bw = 0.03,
              scale = "width")+
  geom_boxplot(size = 0.5,
               linewidth = 0.4,
               width = 0.2,
               fill = "grey",
               outlier.alpha = 0) +
  geom_point(data = emm_injury_season %>% 
               data.frame() %>% 
               mutate(season2 = fct_relevel(season2,
                                            "nonmating", "mating_an")),
             aes(y = response),
             size = 3,
             color = "white") +
  geom_errorbar(data = emm_injury_season %>% 
               data.frame() %>% 
               mutate(season2 = fct_relevel(season2,
                                            "nonmating", "mating_an")),
             aes(y = response, ymin = lower.HPD,
                 ymax = upper.HPD),
             size = 0.4,
             color = "white",
             width = 0.1) +
  geom_signif(comparisons = list(c("nonmating", "mating_es"),
                                 c("nonmating", "mating_an"),
                                 c("mating_an", "mating_es")),
              y_position = c(0.55, 0.1, 0.5),
              annotations = rep("***", 3)) +
  theme_bw(base_size = 12) +
  scale_x_discrete(labels = c("NMS", "MS (anestrus)", "MS (estrous)")) +
  labs(x = "", y = "Proportion of injured days (n/days)") +
  theme(text = element_text(family = "Times New Roman"),
        aspect.ratio = 1) -> p_injury_season

p_injury_season

ggsave("figures/p_injury_season.tif", p_injury_season,
       dpi = 2000, units = "mm",
       width = 100, height = 100)
```
<br/>  

### 被攻撃頻度と怪我の有無の関連  
続いて、交尾期のデータを対象にメスの被攻撃頻度と怪我の有無の間に関連があるかを調べます。  

#### モデリング  
### モデリング  
それでは、モデリングを行います。分析には、その日個体追跡を行わなかった個体のデータのみを用います。これは、個体追跡をした個体は被攻撃頻度が他の個体に比べて過大評価されてしまう傾向があるからです。また、先ほどと同様に240分以上群れを追跡した日のデータのみを用います。    

- 分布: ベルヌーイ分布    
- リンク関数: ロジット関数    
- 応答変数: 怪我が確認されたか否か(`injury01`)           
- 説明変数: オスからの攻撃頻度(`rate_agg`)、メスの発情の有無(`rs2`)、追跡時間(`duration`)、 調査期間(`study_period`)  
- ランダム切片: メスID(`femaleID`)      

```{r}
injury_analysis <- injury_final %>% 
  filter(duration >= 240) %>% 
  filter(focal == 0) %>% 
  filter(!str_detect(study_period, "nm")) %>% 
  mutate(rate_agg = no_agg*60/duration) %>% 
  mutate(rate_agg_std = standardize(rate_agg))

m_agginj <- brm(injury01 ~ rate_agg_std*rs2  + study_period + (1|femaleID),
                family = bernoulli,
                iter = 11000, warmup = 1000, seed = 122,
                 prior = c(prior(student_t(4,0,15), class = "b"),
                           prior(student_t(4,0,15), class = "Intercept"),
                           prior(student_t(4,0,10), class = "sd")),
                 control=list(adapt_delta = 0.9999, max_treedepth = 20),
                 backend = "cmdstanr",
                 data = injury_analysis,
                 file = "model/m_agginj.rds")
```

#### モデルチェック  
まず、DHARMaパッケージ[@Hartig2022]とDHARMa.helperパッケージ[@Francisco2023]でモデルの前提が満たされているかを確認する。いずれのモデルも特に問題はないよう。 
```{r, fig.height = 4}
## 全期間    
dh_agginj <- dh_check_brms(m_agginj, quantreg = TRUE)
```
<br/>  

ゼロ過剰などの問題もない。  
```{r}
testZeroInflation(dh_agginj)
```
<br/>  

bayesplotパッケージ[@Gabry2022]の`pp_check`関数で、事後分布からの予測分布と実測値の分布を比較しても大きな乖離はない。   
```{r, fig.height = 4.5}
## 全期間    
pp_check(m_agginj, ndraws = 100)+
  theme_bw()+
  theme(aspect.ratio = 0.9)
```  
<br/>  

多重共線性のチェックも行ったが、VIFに問題はない。  
```{r}
## 全期間  
check_collinearity(m_agginj)
```
<br/>  

Rhatにも問題はなく、収束の問題はないよう。  
```{r, fig.dim = c(8,4)}
data.frame(Rhat = brms::rhat(m_agginj)) %>% 
  ggplot(aes(x = Rhat))+
  geom_histogram(fill = "white",
                 color = "black")+
  theme_bw()+
  theme(aspect.ratio = 1)
```
<br/>  

#### 結果の確認  
##### 推定された係数  
まずは、推定された係数を確認します。  
```{r, echo = FALSE}
summary_agginj <- summary(m_agginj)

model_parameters(m_agginj, dispersion = TRUE, ci = 0.95,
                 centrality = "median", ci_method = "eti") %>% 
  data.frame() %>%
  dplyr::select(1,2,3,5,6, 7,8) %>% 
  mutate("Bulk ESS" = summary_agginj$fixed$Bulk_ESS,
         "Tail ESS" = summary_agginj$fixed$Tail_ESS) %>% 
  mutate("95%CI" = str_c("[",sprintf("%.2f",CI_low),", ",sprintf("%.2f",CI_high),"]")) %>% 
  dplyr::select(c(1,2,3, 10), everything()) %>% 
  dplyr::select(-CI_low, -CI_high) %>% 
  mutate(pd = str_c(sprintf("%.2f",pd*100))) %>% 
  rename(`PD (%)` = pd) %>% 
  mutate(Parameter = fct_relevel(Parameter,
                                 "b_Intercept", "b_rate_agg_std", "b_rs2",
                                 "b_rate_agg_std:rs2",
                                 "b_study_periodm19", "b_study_periodm20","b_study_periodm21")) %>% 
  arrange(Parameter) %>% 
  mutate(Parameter = str_replace_all(Parameter, c("b_Intercept"="Intercept",
                                                  "^b_rate_agg_std$" = "Frequency of aggression",
                                                  "b_rs2" = "Estrous status (estrous vs anestrus)",
                                                  "b_rate_agg_std:rs2" = "Frequency of aggression x\nEstrous status",
                                                  "b_study_periodm19" = "Study period (MS19 vs MS18)",      
                                                  "b_study_periodm20" = "Study period (MS20 vs MS18)",
                                                  "b_study_periodm21" = "Study period (MS21 vs MS18)"))) %>% 
  rename("Explanatory variables" = "Parameter") %>% 
  mutate(across(where(is.numeric), ~sprintf("%.2f", .))) -> table_agginj

table_agginj

write_csv(table_agginj, "tables/table_agginj.csv")
```
<br/>  

##### 交互作用項の検討  
続いて、季節/発情の有無について多重比較を行います。いずれも有意な差があることが分かります。    
```{r}
estimate_slopes(m_agginj,
                trend = "rate_agg_std",
                by = "rs2 = c(0,1)",
                ci_method = "eti") %>% 
  data.frame()
```

#### 結果の図示  
```{r}
predict_agginj <- predict_response(m_agginj,
                                   terms = c("rate_agg_std[-0.4:13.4, by = 0.1]", "rs2[0:1, by = 1]"),
                                   type = "fixed",
                                   margin = "marginalmeans",
                                   interval = "confidence",
                                   ci_method = "ci",
                                   ci_level = 0.95) %>% 
  data.frame() %>% 
  rename(rate_agg_std = x,
         rs2 = group) %>% 
  mutate(rate_agg = rate_agg_std*sd(injury_analysis$rate_agg) + mean(injury_analysis$rate_agg)) %>% 
  mutate(rs2 = as.factor(rs2))

injury_analysis %>% 
  mutate(rs2 = as.factor(rs2)) %>% 
  ggplot(aes(x = rate_agg, y = injury01))+
  geom_point(shape = "|", size = 3,
             alpha = 0.5,
             aes(color = rs2)) +
  scale_color_nejm(labels = c("Anestrus", "Estrous")) +
  geom_line(data = predict_agginj,
            aes(y = predicted,
                linetype = rs2),
            linewidth = 0.4) +
  geom_ribbon(data = predict_agginj,
              aes(y = predicted,
                  ymax = conf.high, ymin = conf.low,
                  fill = rs2),
              alpha = 0.2) +
  scale_fill_nejm(labels = c("Anestrus", "Estrous")) +
  scale_linetype_manual(values = c("solid", "dashed"),
                        labels = c("Anestrus", "Estrous")) +
  theme_bw(base_size = 12) +
  scale_y_continuous(breaks = seq(0,1,by = 0.2)) +
  scale_x_continuous(breaks = seq(0,1.4, 0.2)) +
  labs(x = "Frequency of aggression", y = "Presence of new injury",
       color = "Estrous status", linetype = "Estrous status", fill = "Estrous status") +
  theme(text = element_text(family = "Times New Roman"),
        aspect.ratio = 1)  -> p_agginj_all

p_agginj_all

ggsave("figures/p_agginj_all.png", p_agginj_all,
       width = 120, height = 100, units = "mm", dpi = 2000)
```

