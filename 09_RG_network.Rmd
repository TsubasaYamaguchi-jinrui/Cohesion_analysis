# 休息中のネットワーク  
休息集団のネットワークを書くことで、TYが休息集団内でどのような位置を占めていたのかを明らかにします。    

## データの加工   
まず、休息集団の隣接行列を作成するためのデータを作成します。    
各個体が休息集団にいたかを表すgroup by individual 形式のデータを作成します。  

- 地上休息中のみを抽出    
- 非発情メスのものと発情メスのものは区別    
- 交尾期と非交尾期は区別    
- *IT*がいた時期に絞ったネットワークも作成します。   
- メスは2019年時点で6歳以上の個体のみを含みます。  
- オスは`TY`、`IT`、`KR`のみを含みます。  


```{r}
focal_RG_an <- focal_prox %>% 
  left_join(female_all %>% select(femaleID, date, rs2),
            by = c("subject" = "femaleID")) %>% 
  filter(rs2 == 0) %>% 
  filter(RG == "1" & T_G == "G") %>% 
  mutate(focalID = str_c(study_period, "_", no_focal)) %>% 
  filter((study_period == "m18" & ID %in% c(adult18, "TY", "IT", "KR"))|
            (study_period == "nm19" & ID %in% c(adult18, "TY", "IT", "KR"))|
            (study_period == "m19" & ID %in% c(adult19, "TY", "IT", "KR"))|
            (study_period == "m20" & ID %in% c(adult20, "TY", "IT", "KR"))|
            (study_period == "nm21" & ID %in% c(adult20, "TY", "IT", "KR"))|
            (study_period == "m21" & ID %in% c(adult21, "TY", "IT", "KR"))|
            (study_period == "nm22" & ID %in% c(adult21, "TY", "IT", "KR"))) %>% 
  select(date, study_period, focalID, time, TY_presence, IT_presence, subject, ID) %>% 
  mutate(presence = 1) %>% 
  complete(nesting(date, study_period, focalID, time, TY_presence, IT_presence, subject), ID = ID) %>% 
  mutate(presence = if_else(subject == ID, 1, presence)) %>% 
  replace_na(list(presence = 0)) %>% 
  pivot_wider(names_from = ID,
              values_from = presence) 
```

## ネットワーク分析    
各年の群れオスと6歳以上のメスでネットワークを作成する。  

```{r}
female_list <- c("Mik", "Kil", "Tam", "Koh", "Aka", "Ntr", "Ten", "Hen", 
                 "Hot", "Mei", "Ako", "Kol", "Mal", "Kit", "Kun", "Mif")

focal_RG %>% 
  select(1:6, one_of(female_list), TY, IT, KR) -> a

b <- a %>% filter(TY_presence == 1) %>% filter(!str_detect(study_period, "nmm"))
c <- a %>% filter(TY_presence == 0) %>% filter(!str_detect(study_period, "nmm"))

matRG <- get_network(a %>% select(-(1:6)),
                          data_format = "GBI",
                          association_index = "SRI")


matRG2 <- get_network(c %>% select(-(1:6)),
                          data_format = "GBI",
                          association_index = "SRI")

met.eigen(matRG)

focal_RG %>% 
  group_by(study_period, subject) %>% 
  summarise(n = n()) -> z
```

```{r}

```


### 2018年  

#### 隣接行列の作成  
```{r}
RG_gbi %>% 
  filter(str_detect(no_focal,"m18")) %>% 
  select(-(1:4), -Coc,-Anz,-Har,-KM,-Ntm,-Trt,-rs2,-Mif,-TYpre,-ITpre) -> gbi_2018

## 隣接行列を取得
matRG_2018 <- get_network(gbi_2018,
                          data_format = "GBI",
                          association_index = "HWI")

met.eigen(matRG)
```

隣接行列は以下の通り。  
```{r}
matRG_2018 %>% 
  data.frame() %>% 
  rownames_to_column(var = " ")
```

#### 固有ベクトル中心性の算出    
各個体の固有ベクトル中心性は以下の通り。ほかのオスに比べるとTYがかなり高く、中心的であることが分かる。    
```{r}
ID18 <- data.frame(ID = c(adult18,"TY","IT","LK","KR"))

met.eigen(matRG_2018,
          df = ID18,
          dfid = 1) -> ID18_b

ID18_b
```

```{r}
ID18_b %>% 
  mutate(mf = ifelse(ID %in% adult18,"メス",ID)) %>% 
  group_by(mf) %>% 
  summarise(mean = mean(eigen),
            sd = sd(eigen)) %>%
  ungroup() %>% 
  replace_na(list(sd = 0)) %>% 
  mutate(mf = fct_relevel(mf,"TY","IT","LK","KR","メス")) %>% 
  ggplot(aes(x = mf))+
  geom_pointrange(aes(y = mean, ymin = mean - sd, ymax = mean + sd),
                  size = 1)+
  theme_bw(base_size = 15)+
  labs(y = "固\n有\nベ\nク\nト\nル\n中\n心\n性", x = "")+
  theme(aspect.ratio = 1,
        axis.text.x =  element_text(family = "Times New Roman"),
        axis.title.y = element_text(family = "Yu Mincho",
                                    angle = 0,
                                    vjust = 0.5),
        legend.text = element_text(family = "Yu Mincho"),
        axis.text.y = element_text(family = "Times New Roman")) -> p_eigen18

p_eigen18

# ggsave("figure/p_eigen18.png", p_eigen18, dpi = 600, width = 90, height = 90, units = "mm")
```

#### ネットワーク図の描画  
```{r}
matRG_2018 %>% 
  as_tbl_graph(directed = FALSE) %>%
  ## `tbl_graph`に重み付き中心性の情報を追加
  mutate(eigen = ID18_b$eigen) %>% 
  ggraph(layout = "nicely")+
  scale_size(range = c(6,13))+
  geom_edge_link(aes(width = weight),color = "grey65",
                 end_cap = circle(0.5,"cm"),
                 start_cap = circle(0.5,"cm"))+
  geom_node_point(aes(size = eigen), shape = 16, color = "black")+
  geom_node_text(aes(label = name), color = "white")+
  scale_edge_width(range = c(0.5,2))+
  theme_graph() -> p_RG18

p_RG18

# ggsave("figure/p_RG18.png", height = 160,width =160, dpi = 600, units= "mm")
```

### 2019年  
#### 隣接行列の作成  
TYがいる日といない日で分ける。ITはいない日が多かったので省く。  

**TYのいる日**  
```{r}
RG_gbi %>% 
  filter(str_detect(no_focal,"m19")) %>% 
  filter(TYpre == "1") %>% 
  select(-(1:4), -Coc,-Anz,-Har,-KM,-Ntm,-Trt,-rs2,-TYpre, -ITpre, -IT, -Kur) -> gbi_2019_TY

## 隣接行列を取得
matRG_2019_TY <- get_network(gbi_2019_TY,
                             data_format = "GBI",
                             association_index = "HWI")
```

**TYのいない日**  
```{r}
RG_gbi %>% 
  filter(str_detect(no_focal,"m19")) %>% 
  filter(TYpre == "0") %>% 
  select(-(1:4), -Coc,-Anz,-Har,-KM,-Ntm,-Trt,-rs2,-TYpre, -ITpre, -IT,-TY, -Kur) -> gbi_2019_notTY

## 隣接行列を取得
matRG_2019_notTY <- get_network(gbi_2019_notTY,
                             data_format = "GBI",
                             association_index = "HWI")
```

隣接行列は以下の通り。  

**TYがいる日**  
```{r}
matRG_2019_TY %>% 
  data.frame() %>% 
  rownames_to_column(var = " ")
```

**TYがいない日**  
```{r}
matRG_2019_notTY %>% 
  data.frame() %>% 
  rownames_to_column(var = " ")
```

#### 固有ベクトル中心性の算出    
各個体の固有ベクトル中心性は以下の通り。

**TYのいる日**  

やはりほかのオスに比べるとTYが一番高い。  
```{r}
ID19_TY <- data.frame(ID = c(adult19,"TY","LK","KR"))

met.eigen(matRG_2019_TY,
          df = ID19_TY ,
          dfid = 1) %>% 
  drop_na() -> ID19_TY_b

ID19_TY_b
```

```{r}
ID19_TY_b %>% 
  mutate(mf = ifelse(ID %in% adult19,"メス",ID)) %>% 
  group_by(mf) %>% 
  summarise(mean = mean(eigen),
            sd = sd(eigen)) %>%
  ungroup() %>% 
  replace_na(list(sd = 0)) %>% 
  mutate(mf = fct_relevel(mf,"TY","LK","KR","メス")) %>% 
  ggplot(aes(x = mf))+
  geom_pointrange(aes(y = mean, ymin = mean - sd, ymax = mean + sd),
                  size = 1)+
  theme_bw(base_size = 15)+
  labs(y = "固\n有\nベ\nク\nト\nル\n中\n心\n性", x = "")+
  theme(aspect.ratio = 1,
        axis.text.x =  element_text(family = "Times New Roman"),
        axis.title.y = element_text(family = "Yu Mincho",
                                    angle = 0,
                                    vjust = 0.5),
        legend.text = element_text(family = "Yu Mincho"),
        axis.text.y = element_text(family = "Times New Roman")) -> p_eigen19_TY

p_eigen19_TY

# ggsave("figure/p_eigen19_TY.png", p_eigen19_TY, dpi = 600, width = 90, height = 90, units = "mm")
```

**TYのいない日**  
いない日は、*LK*の中心性がとても高くなる。  
```{r}
ID19_notTY <- data.frame(ID = c(adult19,"LK","KR"))

met.eigen(matRG_2019_notTY,
          df = ID19_notTY ,
          dfid = 1) %>% 
  drop_na() -> ID19_notTY_b

ID19_notTY_b
```

```{r}
ID19_notTY_b %>% 
  mutate(mf = ifelse(ID %in% adult19,"メス",ID)) %>% 
  group_by(mf) %>% 
  summarise(mean = mean(eigen),
            sd = sd(eigen)) %>%
  ungroup() %>% 
  replace_na(list(sd = 0)) %>% 
  mutate(mf = fct_relevel(mf,"TY","LK","KR","メス")) %>% 
  ggplot(aes(x = mf))+
  geom_pointrange(aes(y = mean, ymin = mean - sd, ymax = mean + sd),
                  size = 1)+
  theme_bw(base_size = 15)+
  labs(y = "固\n有\nベ\nク\nト\nル\n中\n心\n性", x = "")+
  theme(aspect.ratio = 1,
        axis.text.x =  element_text(family = "Times New Roman"),
        axis.title.y = element_text(family = "Yu Mincho",
                                    angle = 0,
                                    vjust = 0.5),
        legend.text = element_text(family = "Yu Mincho"),
        axis.text.y = element_text(family = "Times New Roman")) -> p_eigen19_notTY

p_eigen19_notTY

# ggsave("figure/p_eigen19_notTY.png", p_eigen19_notTY, dpi = 600, width = 90, height = 90, units = "mm")
```

#### ネットワーク図の描画  
```{r}
matRG_2019_TY %>% 
  as_tbl_graph(directed = FALSE) %>%
  ## `tbl_graph`に重み付き中心性の情報を追加
  mutate(eigen = ID19_TY_b$eigen) %>% 
  ggraph(layout = "nicely")+
  scale_size(range = c(6,13))+
  geom_edge_link(aes(width = weight),color = "grey65",
                 end_cap = circle(0.5,"cm"),
                 start_cap = circle(0.5,"cm"))+
  geom_node_point(aes(size = eigen), shape = 16, color = "black")+
  geom_node_text(aes(label = name), color = "white")+
  scale_edge_width(range = c(0.5,2))+
  theme_graph() -> p_RG19_TY

p_RG19_TY

# ggsave("figure/p_RG19_TY.png", p_RG19_TY, height = 160,width =160, dpi = 600, units= "mm")
```

```{r}
matRG_2019_notTY %>% 
  as_tbl_graph(directed = FALSE) %>%
  ## `tbl_graph`に重み付き中心性の情報を追加
  mutate(eigen = ID19_notTY_b$eigen) %>% 
  ggraph(layout = "nicely")+
  scale_size(range = c(6,13))+
  geom_edge_link(aes(width = weight),color = "grey65",
                 end_cap = circle(0.5,"cm"),
                 start_cap = circle(0.5,"cm"))+
  geom_node_point(aes(size = eigen), shape = 16, color = "black")+
  geom_node_text(aes(label = name), color = "white")+
  scale_edge_width(range = c(0.5,2))+
  theme_graph() -> p_RG19_notTY

p_RG19_notTY

# ggsave("figure/p_RG19_notTY.png", p_RG19_notTY, height = 160,width =160, dpi = 600, units= "mm")
```

#### 下位構造の検出  
**TYがいる日**  
```{r}
graph19_TY <- graph_from_adjacency_matrix(matRG_2019_TY,
                                           ## 有向グラフなら "directed"
                                           mode= "undirected", 
                                           ## 重みなしなら NULL
                                           weighted = TRUE) 

cluster_optimal(graph19_TY,
                weights = E(graph19_TY)$weight) -> cluster_RG19_TY
```

クラスターのグループ分けは以下の通り。   
4つに分かれる。  
```{r}
cluster_RG19_TY
```

モジュラリティは以下の通り。モジュラリティ―は2つに分ける場合は-0.5~0.5の間をとる。0.1なので、あまり大きくはない。  
```{r}
modularity(cluster_RG19_TY, directed = FALSE, weights = NULL)
```

**TYがいない日**  
```{r}
graph19_notTY <- graph_from_adjacency_matrix(matRG_2019_notTY,
                                           ## 有向グラフなら "directed"
                                           mode= "undirected", 
                                           ## 重みなしなら NULL
                                           weighted = TRUE) 

cluster_optimal(graph19_notTY,
                weights = E(graph19_notTY)$weight) -> cluster_RG19_notTY
```

クラスターのグループ分けは以下の通り。   
3つに分かれる。  
```{r}
cluster_RG19_notTY
```

モジュラリティは以下の通り。モジュラリティ―は2つに分ける場合は-0.5~0.5の間をとる。0.25なので結構大きい。   
```{r}
modularity(cluster_RG19_notTY, directed = FALSE, weights = NULL)
```

### 2020年  
#### 隣接行列の作成  
TYがいる日といない日で分ける。ITはいない日が多かったので省く。  

**TYのいる日**  
```{r}
RG_gbi %>% 
  filter(str_detect(no_focal,"m20")) %>% 
  filter(TYpre == "1") %>% 
  select(-(1:4), -Har,-KM,-rs2,-TYpre, -ITpre, -IT, -Kur, -LK) -> gbi_2020_TY

## 隣接行列を取得
matRG_2020_TY <- get_network(gbi_2020_TY,
                             data_format = "GBI",
                             association_index = "HWI")
```

**TYのいない日**  
```{r}
RG_gbi %>% 
  filter(str_detect(no_focal,"m20")) %>% 
  filter(TYpre == "0") %>% 
  select(-(1:4), -Har,-KM,-rs2,-TYpre, -ITpre, -IT,-TY, -Kur, -LK) -> gbi_2020_notTY

## 隣接行列を取得
matRG_2020_notTY <- get_network(gbi_2020_notTY,
                             data_format = "GBI",
                             association_index = "HWI")
```

隣接行列は以下の通り。  

**TYがいる日**  
```{r}
matRG_2020_TY %>% 
  data.frame() %>% 
  rownames_to_column(var = " ")
```

**TYがいない日**  
```{r}
matRG_2020_notTY %>% 
  data.frame() %>% 
  rownames_to_column(var = " ")
```

#### 固有ベクトル中心性の算出    
各個体の固有ベクトル中心性は以下の通り。

**TYのいる日**  

KRに比べるとTYの方が高いが、過去2年に比べると低い？  
```{r}
ID20_TY <- data.frame(ID = c(adult20,"TY","KR"))

met.eigen(matRG_2020_TY,
          df = ID20_TY ,
          dfid = 1) %>% 
  drop_na() -> ID20_TY_b

ID20_TY_b
```

```{r}
ID20_TY_b %>% 
  mutate(mf = ifelse(ID %in% adult20,"メス",ID)) %>% 
  group_by(mf) %>% 
  summarise(mean = mean(eigen),
            sd = sd(eigen)) %>%
  ungroup() %>% 
  replace_na(list(sd = 0)) %>% 
  mutate(mf = fct_relevel(mf,"TY","LK","KR","メス")) %>% 
  ggplot(aes(x = mf))+
  geom_pointrange(aes(y = mean, ymin = mean - sd, ymax = mean + sd),
                  size = 1)+
  theme_bw(base_size = 15)+
  labs(y = "固\n有\nベ\nク\nト\nル\n中\n心\n性", x = "")+
  theme(aspect.ratio = 1,
        axis.text.x =  element_text(family = "Times New Roman"),
        axis.title.y = element_text(family = "Yu Mincho",
                                    angle = 0,
                                    vjust = 0.5),
        legend.text = element_text(family = "Yu Mincho"),
        axis.text.y = element_text(family = "Times New Roman")) -> p_eigen20_TY

p_eigen20_TY

# ggsave("figure/p_eigen20_TY.png", p_eigen20_TY, dpi = 600, width = 90, height = 90, units = "mm")
```

**TYのいない日**  
KRはTYがいなくてもあまり高くない。  
```{r}
ID20_notTY <- data.frame(ID = c(adult20,"LK","KR"))

met.eigen(matRG_2020_notTY,
          df = ID20_notTY ,
          dfid = 1) %>% 
  drop_na() -> ID20_notTY_b

ID20_notTY_b
```

```{r}
ID20_notTY_b %>% 
  mutate(mf = ifelse(ID %in% adult20,"メス",ID)) %>% 
  group_by(mf) %>% 
  summarise(mean = mean(eigen),
            sd = sd(eigen)) %>%
  ungroup() %>% 
  replace_na(list(sd = 0)) %>% 
  mutate(mf = fct_relevel(mf,"TY","LK","KR","メス")) %>% 
  ggplot(aes(x = mf))+
  geom_pointrange(aes(y = mean, ymin = mean - sd, ymax = mean + sd),
                  size = 1)+
  theme_bw(base_size = 15)+
  labs(y = "固\n有\nベ\nク\nト\nル\n中\n心\n性", x = "")+
  theme(aspect.ratio = 1,
        axis.text.x =  element_text(family = "Times New Roman"),
        axis.title.y = element_text(family = "Yu Mincho",
                                    angle = 0,
                                    vjust = 0.5),
        legend.text = element_text(family = "Yu Mincho"),
        axis.text.y = element_text(family = "Times New Roman")) -> p_eigen20_notTY

p_eigen20_notTY

# ggsave("figure/p_eigen20_notTY.png", p_eigen20_notTY, dpi = 600, width = 90, height = 90, units = "mm")
```

#### ネットワーク図の描画  
```{r}
matRG_2020_TY %>% 
  as_tbl_graph(directed = FALSE) %>%
  ## `tbl_graph`に重み付き中心性の情報を追加
  mutate(eigen = ID20_TY_b$eigen) %>% 
  ggraph(layout = "nicely")+
  scale_size(range = c(6,13))+
  geom_edge_link(aes(width = weight),color = "grey65",
                 end_cap = circle(0.5,"cm"),
                 start_cap = circle(0.5,"cm"))+
  geom_node_point(aes(size = eigen), shape = 16, color = "black")+
  geom_node_text(aes(label = name), color = "white")+
  scale_edge_width(range = c(0.5,2))+
  theme_graph() -> p_RG20_TY

p_RG20_TY

# ggsave("figure/p_RG20_TY.png", p_RG20_TY, height = 160,width =160, dpi = 600, units= "mm")
```

```{r}
matRG_2020_notTY %>% 
  as_tbl_graph(directed = FALSE) %>%
  ## `tbl_graph`に重み付き中心性の情報を追加
  mutate(eigen = ID20_notTY_b$eigen) %>% 
  ggraph(layout = "nicely")+
  scale_size(range = c(6,13))+
  geom_edge_link(aes(width = weight),color = "grey65",
                 end_cap = circle(0.5,"cm"),
                 start_cap = circle(0.5,"cm"))+
  geom_node_point(aes(size = eigen), shape = 16, color = "black")+
  geom_node_text(aes(label = name), color = "white")+
  scale_edge_width(range = c(0.5,2))+
  theme_graph() -> p_RG20_notTY

p_RG20_notTY

# ggsave("figure/p_RG20_notTY.png", p_RG20_notTY, height = 160,width =160, dpi = 600, units= "mm")
```

#### 下位構造の検出  
**TYがいる日**  
```{r}
graph20_TY <- graph_from_adjacency_matrix(matRG_2020_TY,
                                           ## 有向グラフなら "directed"
                                           mode= "undirected", 
                                           ## 重みなしなら NULL
                                           weighted = TRUE) 

cluster_optimal(graph20_TY,
                weights = E(graph20_TY)$weight) -> cluster_RG20_TY
```

クラスターのグループ分けは以下の通り。   
6つに分かれる。  
```{r}
cluster_RG20_TY
```

モジュラリティは以下の通り。モジュラリティ―は2つに分ける場合は-0.5~0.5の間をとる。0.22なのでそこそこ大きい?    
```{r}
modularity(cluster_RG20_TY, directed = FALSE, weights = NULL)
```

**TYがいない日**  
```{r}
graph20_notTY <- graph_from_adjacency_matrix(matRG_2020_notTY,
                                           ## 有向グラフなら "directed"
                                           mode= "undirected", 
                                           ## 重みなしなら NULL
                                           weighted = TRUE) 

cluster_optimal(graph20_notTY,
                weights = E(graph20_notTY)$weight) -> cluster_RG20_notTY
```

クラスターのグループ分けは以下の通り。   
3つに分かれる。  
```{r}
cluster_RG20_notTY
```

モジュラリティは以下の通り。モジュラリティ―は2つに分ける場合は-0.5~0.5の間をとる。0.17なので、まあまあ大きい。  
```{r}
modularity(cluster_RG20_notTY, directed = FALSE, weights = NULL)
```

### 2021年  
#### 隣接行列の作成  
TYがいる日といない日で分ける。ITはいない日が多かったので省く。  

**TYのいる日**  
```{r}
RG_gbi %>% 
  filter(str_detect(no_focal,"m21")) %>% 
  filter(TYpre == "1") %>% 
  select(-(1:4), -rs2,-TYpre, -ITpre, -IT, -Kur, -LK, -Tam) -> gbi_2021_TY

## 隣接行列を取得
matRG_2021_TY <- get_network(gbi_2021_TY,
                             data_format = "GBI",
                             association_index = "HWI")
```

**TYのいない日**  
```{r}
RG_gbi %>% 
  filter(str_detect(no_focal,"m21")) %>% 
  filter(TYpre == "0") %>% 
  select(-(1:4), -rs2,-TYpre, -ITpre, -IT,-TY, -Kur, -LK, -Tam) -> gbi_2021_notTY

## 隣接行列を取得
matRG_2021_notTY <- get_network(gbi_2021_notTY,
                             data_format = "GBI",
                             association_index = "HWI")
```

隣接行列は以下の通り。  

**TYがいる日**  
```{r}
matRG_2021_TY %>% 
  data.frame() %>% 
  rownames_to_column(var = " ")
```

**TYがいない日**  
```{r}
matRG_2021_notTY %>% 
  data.frame() %>% 
  rownames_to_column(var = " ")
```

#### 固有ベクトル中心性の算出    
各個体の固有ベクトル中心性は以下の通り。

**TYのいる日**  

TYがかなり大きいが、KRも2番目に大きくなっている。  
```{r}
ID21_TY <- data.frame(ID = c(adult21,"TY","KR","KM"))

met.eigen(matRG_2021_TY,
          df = ID21_TY ,
          dfid = 1) %>% 
  drop_na() -> ID21_TY_b

ID21_TY_b
```

```{r}
ID21_TY_b %>% 
  mutate(mf = ifelse(ID %in% adult21,"メス",ID)) %>% 
  group_by(mf) %>% 
  summarise(mean = mean(eigen),
            sd = sd(eigen)) %>%
  ungroup() %>% 
  replace_na(list(sd = 0)) %>% 
  mutate(mf = fct_relevel(mf,"TY","LK","KR","KM","メス")) %>% 
  ggplot(aes(x = mf))+
  geom_pointrange(aes(y = mean, ymin = mean - sd, ymax = mean + sd),
                  size = 1)+
  theme_bw(base_size = 15)+
  labs(y = "固\n有\nベ\nク\nト\nル\n中\n心\n性", x = "")+
  theme(aspect.ratio = 1,
        axis.text.x =  element_text(family = "Times New Roman"),
        axis.title.y = element_text(family = "Yu Mincho",
                                    angle = 0,
                                    vjust = 0.5),
        legend.text = element_text(family = "Yu Mincho"),
        axis.text.y = element_text(family = "Times New Roman")) -> p_eigen21_TY

p_eigen21_TY

# ggsave("figure/p_eigen21_TY.png", p_eigen21_TY, dpi = 600, width = 90, height = 90, units = "mm")
```

**TYのいない日**  
KRはそこそこ高い。KMは0。   
```{r}
ID21_notTY <- data.frame(ID = c(adult21,"LK","KR","KM"))

met.eigen(matRG_2021_notTY,
          df = ID21_notTY ,
          dfid = 1) %>% 
  drop_na() -> ID21_notTY_b

ID21_notTY_b
```

```{r}
ID21_notTY_b %>% 
  mutate(mf = ifelse(ID %in% adult21,"メス",ID)) %>% 
  group_by(mf) %>% 
  summarise(mean = mean(eigen),
            sd = sd(eigen)) %>%
  ungroup() %>% 
  replace_na(list(sd = 0)) %>% 
  mutate(mf = fct_relevel(mf,"TY","LK","KR","KM","メス")) %>% 
  ggplot(aes(x = mf))+
  geom_pointrange(aes(y = mean, ymin = mean - sd, ymax = mean + sd),
                  size = 1)+
  theme_bw(base_size = 15)+
  labs(y = "固\n有\nベ\nク\nト\nル\n中\n心\n性", x = "")+
  theme(aspect.ratio = 1,
        axis.text.x =  element_text(family = "Times New Roman"),
        axis.title.y = element_text(family = "Yu Mincho",
                                    angle = 0,
                                    vjust = 0.5),
        legend.text = element_text(family = "Yu Mincho"),
        axis.text.y = element_text(family = "Times New Roman")) -> p_eigen21_notTY

p_eigen21_notTY

# ggsave("figure/p_eigen21_notTY.png", p_eigen21_notTY, dpi = 600, width = 90, height = 90, units = "mm")
```

#### ネットワーク図の描画  
```{r}
matRG_2021_TY %>% 
  as_tbl_graph(directed = FALSE) %>%
  ## `tbl_graph`に重み付き中心性の情報を追加
  mutate(eigen = ID21_TY_b$eigen) %>% 
  ggraph(layout = "nicely")+
  scale_size(range = c(6,13))+
  geom_edge_link(aes(width = weight),color = "grey65",
                 end_cap = circle(0.5,"cm"),
                 start_cap = circle(0.5,"cm"))+
  geom_node_point(aes(size = eigen), shape = 16, color = "black")+
  geom_node_text(aes(label = name), color = "white")+
  scale_edge_width(range = c(0.5,2))+
  theme_graph() -> p_RG21_TY

p_RG21_TY

# ggsave("figure/p_RG21_TY.png", p_RG21_TY, height = 160,width =160, dpi = 600, units= "mm")
```

```{r}
matRG_2021_notTY %>% 
  as_tbl_graph(directed = FALSE) %>%
  ## `tbl_graph`に重み付き中心性の情報を追加
  mutate(eigen = ID21_notTY_b$eigen) %>% 
  ggraph(layout = "nicely")+
  scale_size(range = c(6,13))+
  geom_edge_link(aes(width = weight),color = "grey65",
                 end_cap = circle(0.5,"cm"),
                 start_cap = circle(0.5,"cm"))+
  geom_node_point(aes(size = eigen), shape = 16, color = "black")+
  geom_node_text(aes(label = name), color = "white")+
  scale_edge_width(range = c(0.5,2))+
  theme_graph() -> p_RG21_notTY

p_RG21_notTY

# ggsave("figure/p_RG21_notTY.png", p_RG21_notTY, height = 160,width =160, dpi = 600, units= "mm")
```

#### 下位構造の検出  
**TYがいる日**  
```{r}
graph21_TY <- graph_from_adjacency_matrix(matRG_2021_TY,
                                           ## 有向グラフなら "directed"
                                           mode= "undirected", 
                                           ## 重みなしなら NULL
                                           weighted = TRUE) 

cluster_optimal(graph21_TY,
                weights = E(graph21_TY)$weight) -> cluster_RG21_TY
```

クラスターのグループ分けは以下の通り。   
3つに分かれる。  
```{r}
cluster_RG21_TY
```

モジュラリティは以下の通り。モジュラリティ―は2つに分ける場合は-0.5~0.5の間をとる。0.09なので小さい。     
```{r}
modularity(cluster_RG21_TY, directed = FALSE, weights = NULL)
```

**TYがいない日**  
```{r}
graph21_notTY <- graph_from_adjacency_matrix(matRG_2021_notTY,
                                           ## 有向グラフなら "directed"
                                           mode= "undirected", 
                                           ## 重みなしなら NULL
                                           weighted = TRUE) 

cluster_optimal(graph21_notTY,
                weights = E(graph21_notTY)$weight) -> cluster_RG21_notTY
```

クラスターのグループ分けは以下の通り。   
3つに分かれる。  
```{r}
cluster_RG21_notTY
```

モジュラリティは以下の通り。モジュラリティ―は6つに分ける場合は-0.5~0.5の間をとる。0.33なので、かなり大きい。  
```{r}
modularity(cluster_RG21_notTY, directed = FALSE, weights = NULL)
```

